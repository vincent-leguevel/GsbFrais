<?php

namespace AL\GsbBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * FicheFraisRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class FicheFraisRepository extends EntityRepository {
    /*
     * Récupère la fiche de frais correspondant à la date ainsi que l'utilisateur
     */

    public function byUserAndDate($date, $user) {
        return $this->createQueryBuilder('u')
                        ->where('u.utilisateur = :user and u.dateRedac like :date')
                        ->setParameter('user', $user)
                        ->setParameter('date', $date . '%')
                        ->getQuery()
                        ->getOneOrNullResult();
    }

    /**
     * Récupère uniquement les fiches de frais du mois actuel ainsi que celles du mois précédent 
     */
    public function consulterByUserAndDate($user, $date) {
        return $this->createQueryBuilder('u')
                        ->where('u.utilisateur = :user and u.dateRedac <= :date')
                        ->orderBy('u.dateRedac ', ' DESC')
                        ->setParameter('user', $user)
                        ->setParameter('date', $date)
                        ->getQuery()
                        ->getResult();
    }

    /**
     * Récupère une fiche de frais en fonction de l'utilisateur de la date ainsi que de l'etat actuel de la fiche
     */
    public function byUserDateEtat($user, $date, $etat) {
        return $this->createQueryBuilder('u')
                        ->where('u.utilisateur = :user and u.dateRedac like :date and u.etat = :etat and u.dateRedac <= :dateRedac')
                        ->orderBy('u.dateRedac ', ' DESC')
                        ->setParameter('user', $user)
                        ->setParameter('date', $date . '%')
                        ->setParameter('etat', $etat)
                        ->setParameter('dateRedac', date('Y').'-'.date('m').'-31')
                        ->getQuery()
                        ->getOneOrNullResult();
    }

}
